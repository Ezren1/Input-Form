<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Universal Intelligence Intake Portal [v3.0 Advanced]</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg-darkest: #050505;
  --bg-dark: #101010;
  --bg-mid: #1A1A1A;
  --border-color: #2A2A2A;
  --text-light: #F0F0F0;
  --text-mid: #999;
  --primary-blue: #00AFFF;
  --primary-hover: #33CFFF;
  --primary-glow: rgba(0, 175, 255, 0.2);
  --secondary-teal: #00FFFF;
  --success: #00FF7F;
  --error: #FF4D4D;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; scroll-behavior: smooth; }
body {
  margin: 0;
  background: var(--bg-darkest);
  font-family: "Montserrat", sans-serif;
  color: var(--text-light);
  line-height: 1.6;
}
.container {
  max-width: 900px;
  margin: 40px auto;
  padding: clamp(25px, 5vw, 50px);
  background: var(--bg-dark);
  border-radius: 16px;
  border: 1px solid var(--border-color);
  box-shadow: 0 10px 60px var(--primary-glow);
}
h1 {
  color: var(--primary-blue);
  margin-top: 0;
  margin-bottom: 10px;
  text-align: center;
  font-size: 2.5rem;
  font-weight: 700;
  letter-spacing: 0.5px;
}
h2 {
  color: var(--primary-blue);
  margin-bottom: 15px;
  border-bottom: 1px solid var(--border-color);
  padding-bottom: 15px;
  font-size: 1.75rem;
  font-weight: 600;
}
.subtitle {
  color: var(--text-mid);
  margin-bottom: 30px;
  text-align: center;
  font-size: 1.1rem;
  font-weight: 400;
}
.step-indicator-container {
  display: flex;
  justify-content: space-between;
  width: 80%;
  margin: 0 auto 40px;
  position: relative;
}
.step-indicator-container::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--border-color);
  transform: translateY(-50%);
  z-index: 1;
}
.step-indicator {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: var(--bg-dark);
  border: 3px solid var(--border-color);
  z-index: 2;
  transition: all 0.4s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-mid);
  font-weight: 600;
}
.step-indicator.active {
  border-color: var(--primary-blue);
  color: var(--primary-blue);
  transform: scale(1.2);
  box-shadow: 0 0 20px rgba(0, 175, 255, 0.7);
  animation: pulse 1.5s infinite;
}
.step-indicator.completed {
  background: var(--primary-blue);
  border-color: var(--primary-blue);
  color: var(--bg-dark);
  font-weight: 700;
}
@keyframes pulse {
  0% { box-shadow: 0 0 20px rgba(0, 175, 255, 0.4); }
  50% { box-shadow: 0 0 30px rgba(0, 175, 255, 0.8); }
  100% { box-shadow: 0 0 20px rgba(0, 175, 255, 0.4); }
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.step { display: none; animation: fadeIn 0.5s ease-out; }
.step.active { display: block; }
.form-group { margin-bottom: 22px; position: relative; }
label {
  display: block;
  margin-bottom: 10px;
  font-weight: 600;
  font-size: 1rem;
  color: var(--text-light);
}
label.optional::after {
  content: "(Optional)";
  font-weight: 400;
  color: var(--text-mid);
  margin-left: 8px;
  font-size: 0.9rem;
}
input[type="text"],
input[type="url"],
input[type="email"],
textarea,
select {
  width: 100%;
  padding: 16px;
  background: var(--bg-mid);
  border: 1px solid var(--border-color);
  color: var(--text-light);
  border-radius: 8px;
  font-size: 1rem;
  font-family: "Montserrat", sans-serif;
  transition: border-color 0.3s, box-shadow 0.3s;
}
input[type="text"]:focus,
input[type="url"]:focus,
input[type="email"]:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: var(--primary-blue);
  box-shadow: 0 0 15px var(--primary-glow);
}
textarea { resize: vertical; min-height: 140px; }
.select-wrapper { position: relative; }
select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  padding-right: 40px;
}
.select-wrapper::after {
  content: 'â–¼';
  position: absolute;
  top: 50%;
  right: 16px;
  transform: translateY(-50%);
  color: var(--primary-blue);
  font-size: 0.8rem;
  pointer-events: none;
}
select option { background: var(--bg-dark); color: var(--text-light); }
.invalid {
  border-color: var(--error) !important;
  box-shadow: 0 0 10px rgba(255, 77, 77, 0.3) !important;
}
.error-message {
  color: var(--error);
  font-size: 0.9rem;
  margin-top: 8px;
  display: none;
  animation: fadeIn 0.3s;
}
.buttons { margin-top: 40px; display: flex; gap: 15px; }
button {
  flex: 1;
  padding: 18px;
  background: var(--primary-blue);
  border: none;
  color: var(--bg-darkest);
  font-weight: 700;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}
button:hover {
  background: var(--primary-hover);
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 175, 255, 0.25);
}
button:disabled {
  background: var(--border-color);
  color: var(--text-mid);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}
button .button-text { transition: opacity 0.2s ease-out; }
button.loading .button-text { opacity: 0; }
.back-btn {
  background: var(--border-color);
  color: var(--text-light);
  box-shadow: none;
}
.back-btn:hover {
  background: #333;
  color: white;
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}
.loader-spinner {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 24px;
  height: 24px;
  margin-top: -12px;
  margin-left: -12px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top-color: var(--bg-darkest);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  display: none;
}
button.loading .loader-spinner { display: block; }
@keyframes spin { to { transform: rotate(360deg); } }
#responseMessage {
  text-align: center;
  font-weight: 600;
  font-size: 1.1rem;
  margin-top: 30px;
  display: none;
  padding: 15px;
  border-radius: 8px;
  animation: fadeIn 0.3s;
}
#responseMessage.success {
  color: var(--success);
  background: rgba(0, 255, 127, 0.1);
  border: 1px solid var(--success);
  display: block;
}
#responseMessage.error {
  color: var(--error);
  background: rgba(255, 77, 77, 0.1);
  border: 1px solid var(--error);
  display: block;
}
.drop-area {
  margin-top: 15px;
  padding: 40px;
  border: 2px dashed #666;
  border-radius: 10px;
  text-align: center;
  color: var(--text-mid);
  cursor: pointer;
  transition: all 0.3s ease;
}
.drop-area.dragover {
  border-color: var(--secondary-teal);
  border-style: solid;
  color: var(--text-light);
  background: var(--bg-mid);
  box-shadow: 0 0 25px rgba(0, 255, 255, 0.3);
}
.drop-area strong {
  color: var(--secondary-teal);
  display: block;
  font-size: 1.2rem;
  margin-bottom: 10px;
}
.drop-area .upload-icon {
  width: 40px;
  height: 40px;
  margin-bottom: 15px;
  color: var(--primary-blue);
}
.preview-toolbar {
  display: flex;
  justify-content: flex-end;
  margin-top: 15px;
  display: none;
}
#clearFilesBtn {
  background: none;
  border: 1px solid var(--error);
  color: var(--error);
  padding: 8px 15px;
  font-size: 0.9rem;
  font-weight: 600;
}
#clearFilesBtn:hover {
  background: var(--error);
  color: var(--bg-darkest);
  box-shadow: 0 0 15px rgba(255, 77, 77, 0.3);
  transform: none;
}
.preview {
  margin-top: 10px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 15px;
}
.preview .file-item {
  border-radius: 8px;
  border: 1px solid var(--border-color);
  overflow: hidden;
  background: var(--bg-mid);
  text-align: center;
  word-break: break-all;
  animation: fadeIn 0.4s ease-out;
}
.preview .file-icon {
  width: 100%;
  height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
  color: var(--primary-blue);
  background: var(--bg-dark);
}
.preview img,
.preview video,
.preview audio {
  width: 100%;
  height: 100px;
  object-fit: cover;
  display: block;
}
.preview audio {
  height: 100px;
  padding: 10px;
  background: var(--bg-dark);
}
.preview .file-name {
  padding: 10px;
  font-size: 0.8rem;
  color: var(--text-mid);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
</style>
</head>
<body>

<div class="container">

  <h1>Universal Intelligence Intake</h1>
  <p class="subtitle">An advanced portal engineered to handle any business scenario.</p>

  <div class="step-indicator-container" id="stepIndicatorContainer">
    <div class="step-indicator active" data-step="1"><span>1</span></div>
    <div class="step-indicator" data-step="2"><span>2</span></div>
    <div class="step-indicator" data-step="3"><span>3</span></div>
    <div class="step-indicator" data-step="4"><span>4</span></div>
    <div class="step-indicator" data-step="5"><span>5</span></div>
  </div>

  <form id="intakeForm" enctype="multipart/form-data" novalidate>

    <div class="step active">
      <h2>1. Basic Business Information</h2>
      <div class="form-group">
        <label for="business_name">Business Name *</label>
        <input type="text" id="business_name" name="business_name" required placeholder="e.g., Eclipse X" />
        <span class="error-message">Business name is required.</span>
      </div>
      <div class="form-group">
        <label for="website_main" class="optional">Main Website URL</label>
        <input type="url" id="website_main" name="website_main" placeholder="https://example.com" />
        <span class="error-message">Please enter a valid URL (e.g., https://example.com or example.com).</span>
      </div>
      <div class="form-group">
        <label for="website_extra" class="optional">Additional Websites (one per line)</label>
        <textarea id="website_extra" name="website_extra" placeholder="https://store.example.com&#10;https://blog.example.com"></textarea>
        <span class="error-message">One or more URLs are invalid. Please check each line.</span>
      </div>
      <div class="form-group">
        <label for="industry" class="optional">Industry</label>
        <input type="text" id="industry" name="industry" placeholder="e.g., SaaS, Real Estate, E-commerce" />
      </div>
      <div class="buttons">
        <button type="button" onclick="nextStep()"><span class="button-text">Next</span><div class="loader-spinner"></div></button>
      </div>
    </div>

    <div class="step">
      <h2>2. Business Details & Strategy</h2>
      <div class="form-group">
        <label for="goal">Primary Objective *</label>
        <div class="select-wrapper">
          <select id="goal" name="goal" required>
            <option value="" disabled selected>Choose your main goal...</option>
            <option value="lead_gen">Lead Generation</option>
            <option value="brand_positioning">Premium Brand Positioning</option>
            <option value="market_expansion">Market Expansion</option>
            <option value="competitor_intel">Competitor Intelligence Audit</option>
            <option value="full_audit">Full Business Audit (Web, SEO, Content)</option>
            <option value="website_creation">New Website Creation</option>
            <option value="other">Other (Describe in fallback)</option>
          </select>
        </div>
        <span class="error-message">Please select your primary objective.</span>
      </div>
      <div class="form-group">
        <label for="description" class="optional">Describe Your Business</label>
        <textarea id="description" name="description" rows="5" placeholder="What do you do? What problems do you solve?"></textarea>
      </div>
      <div class="form-group">
        <label for="target_audience" class="optional">Target Audience</label>
        <textarea id="target_audience" name="target_audience" placeholder="Who are your ideal customers? (Demographics, interests, etc.)"></textarea>
      </div>
      <div class="form-group">
        <label for="socials" class="optional">Social Media Links (one per line)</label>
        <textarea id="socials" name="socials" placeholder="https://instagram.com/yourbrand&#10;https://twitter.com/yourbrand"></textarea>
        <span class="error-message">One or more URLs are invalid. Please check each line.</span>
      </div>
      <div class="buttons">
        <button type="button" class="back-btn" onclick="prevStep()"><span class="button-text">Back</span><div class="loader-spinner"></div></button>
        <button type="button" onclick="nextStep()"><span class="button-text">Next</span><div class="loader-spinner"></div></button>
      </div>
    </div>

    <div class="step">
      <h2>3. Competitor Intelligence</h2>
      <div class="form-group">
        <label for="competitors" class="optional">Competitors (URLs or names, one per line)</label>
        <textarea id="competitors" name="competitors" placeholder="https://competitor1.com&#10;Competitor Brand 2"></textarea>
        </div>
      <div class="form-group">
        <label for="deep_scrape">Website Scraping Level (Your Site) *</label>
        <div class="select-wrapper">
          <select id="deep_scrape" name="deep_scrape" required>
            <option value="" disabled selected>Select scraping depth...</option>
            <option value="no">No Scraping</option>
            <option value="basic">Basic Scrape (Homepage Only)</option>
            <option value="deep_50">Deep Scrape (Up to 50 Pages)</option>
            <option value="full_site">Full Site Scrape (Warning: Slow)</option>
          </select>
        </div>
        <span class="error-message">Please select a scraping level.</span>
      </div>
      <div class="form-group">
        <label for="competitor_scrape">Competitor Scraping *</label>
        <div class="select-wrapper">
          <select id="competitor_scrape" name="competitor_scrape" required>
            <option value="" disabled selected>Scrape competitor sites?</option>
            <option value="yes">Yes â€“ Scrape competitor sites (if provided)</option>
            <option value="no">No â€“ Do not scrape competitors</option>
          </select>
        </div>
        <span class="error-message">Please select a competitor scraping option.</span>
      </div>
      <div class="buttons">
        <button type="button" class="back-btn" onclick="prevStep()"><span class="button-text">Back</span><div class="loader-spinner"></div></button>
        <button type="button" onclick="nextStep()"><span class="button-text">Next</span><div class="loader-spinner"></div></button>
      </div>
    </div>

    <div class="step">
      <h2>4. The "Everything" Upload Portal</h2>
      <p class="subtitle" style="text-align:left; margin: -10px 0 20px 0; font-size: 1rem;">
        Upload absolutely anything. We support all file types.
      </p>
      <div class="form-group">
        <label>Universal Drag & Drop</label>
        <div class="drop-area" id="dropArea">
          <svg class="upload-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor">
            <path d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m6.75 12l-3-3m0 0l-3 3m3-3v6m-1.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <strong>Drag & Drop Files Here</strong>
          <span style="font-size: 0.9rem;">(or click to browse)</span><br>
          <small>Supports: ZIP, PDF, DOCX, MP4, MP3, AI, PSD, JPG, etc.</small>
        </div>
        <input type="file" id="fileInput" name="files" multiple style="display:none;" />
        <div class="preview-toolbar" id="previewToolbar">
            <button type="button" id="clearFilesBtn">Clear All Files</button>
        </div>
        <div class="preview" id="filePreview"></div>
      </div>
      <div class="form-group">
        <label for="logos" class="optional">Specific: Logos (Image, SVG, AI, ZIP)</label>
        <input type="file" id="logos" name="logos" multiple accept="image/*,.zip,.ai,.svg" />
      </div>
      <div class="form-group">
        <label for="brand_docs" class="optional">Specific: Brand Guidelines (PDF, DOCX, ZIP)</label>
        <input type="file" id="brand_docs" name="brand_docs" multiple accept=".pdf,.docx,.zip" />
      </div>
      <div class="form-group">
        <label for="catalogs" class="optional">Specific: Product Catalogs / Spreadsheets</label>
        <input type="file" id="catalogs" name="catalogs" multiple accept=".pdf,.xls,.xlsx,.csv,.zip" />
      </div>
      <div class="form-group">
        <label for="media_audio" class="optional">Specific: Audio (Voice Notes, Explainers)</label>
        <input type="file" id="media_audio" name="media_audio" accept="audio/*" multiple />
      </div>
      <div class="buttons">
        <button type="button" class="back-btn" onclick="prevStep()"><span class="button-text">Back</span><div class="loader-spinner"></div></button>
        <button type="button" onclick="nextStep()"><span class="button-text">Next</span><div class="loader-spinner"></div></button>
      </div>
    </div>

    <div class="step">
      <h2>5. Final Details & Submission</h2>
      <div class="form-group">
        <label for="fallback_info" class="optional">Worst-Case / Missing Info Handler</label>
        <p class="subtitle" style="text-align:left; margin: -5px 0 10px 0; font-size: 0.9rem;">
          If you have almost no info, just a name, or a complex idea, write it here.
        </p>
        <textarea id="fallback_info" name="fallback_info" rows="6" placeholder="e.g., 'My business is 'Eclipse X'. I have no website, no logo. I just want to sell premium tech accessories. Please help me build the brand from scratch.' ... or ... 'See the attached voice memo for a full explanation.'"></textarea>
      </div>
      <div class="form-group">
        <label for="email">Your Email *</label>
        <input type="email" id="email" name="email" required placeholder="your.email@example.com" />
        <span class="error-message">A valid email is required for contact.</span>
      </div>
      <input type="hidden" name="session_id" id="sessionID" />
      <input type="hidden" name="timestamp" id="timestampField" />
      <input type="hidden" name="user_agent" id="userAgentField" />
      <div class="buttons">
        <button type="button" class="back-btn" onclick="prevStep()"><span class="button-text">Back</span><div class="loader-spinner"></div></button>
        <button type="submit" id="submitButton"><span class="button-text">Submit All Intelligence</span><div class="loader-spinner"></div></button>
      </div>
    </div>

    <p id="responseMessage"></p>

  </form>
</div>

<script>
// --- CORE STATE & ELEMENTS ---
let currentStep = 0;
const steps = document.querySelectorAll(".step");
const stepIndicators = document.querySelectorAll(".step-indicator");
const form = document.getElementById("intakeForm");
const responseMessage = document.getElementById("responseMessage");
const submitButton = document.getElementById("submitButton");

// --- STEP NAVIGATION ---
function updateStepIndicator() {
  stepIndicators.forEach((indicator, index) => {
    indicator.classList.remove("active", "completed");
    const indicatorSpan = indicator.querySelector("span");
    if (index < currentStep) {
      indicator.classList.add("completed");
      indicatorSpan.innerHTML = "&#10003;"; // Checkmark
    } else if (index === currentStep) {
      indicator.classList.add("active");
      indicatorSpan.textContent = index + 1;
    } else {
      indicatorSpan.textContent = index + 1;
    }
  });
}

function showStep(stepIndex) {
  steps.forEach((step, i) => step.classList.toggle("active", i === stepIndex));
  currentStep = stepIndex;
  updateStepIndicator();
}

// --- ðŸ’¡ [NEW] SMARTER, CENTRALIZED VALIDATION FUNCTION ---
/**
 * Validates a single form field and updates its UI.
 * @param {HTMLElement} field - The input, textarea, or select element to validate.
 * @returns {boolean} - True if the field is valid, false otherwise.
 */
function validateField(field) {
  let isFieldValid = true;
  const value = field.value; // Get raw value (trimming is just for presence check)
  const trimmedValue = value.trim();
  const type = field.type;
  const id = field.id;
  const isRequired = field.hasAttribute("required");

  const formGroup = field.closest('.form-group');
  const errorSpan = formGroup ? formGroup.querySelector('.error-message') : null;

  // 1. --- Check for Required Fields ---
  if (isRequired && trimmedValue === "") {
    isFieldValid = false;
  }
  
  // 2. --- Check for Format (if a value is present) ---
  if (trimmedValue !== "") {
    if (type === "email") {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(trimmedValue)) {
        isFieldValid = false;
      }
    } 
    else if (type === "url") {
      // "Smart" URL validation: Accepts "google.com"
      try {
        new URL(trimmedValue); // Try as-is
      } catch (_) {
        try {
          new URL("https://" + trimmedValue); // Try with https://
        } catch (_) {
          isFieldValid = false; // Both failed
        }
      }
    }
    else if (id === "website_extra" || id === "socials") {
      // Multi-line URL validation for textareas
      const lines = value.split('\n');
      for (const line of lines) {
        const trimmedLine = line.trim();
        if (trimmedLine === "") continue; // Ignore empty lines

        try {
          new URL(trimmedLine);
        } catch (_) {
          try {
            new URL("https://" + trimmedLine);
          } catch (_) {
            isFieldValid = false; // Any single invalid line fails the whole field
            break;
          }
        }
      }
    }
  }

  // 3. --- Apply Error Styling ---
  if (!isFieldValid) {
    field.classList.add("invalid");
    if (errorSpan) errorSpan.style.display = "block";
  } else {
    field.classList.remove("invalid");
    if (errorSpan) errorSpan.style.display = "none";
  }
  
  return isFieldValid;
}

/**
 * Validates all fields in the current step.
 * @returns {boolean} - True if ALL fields in the step are valid.
 */
function validateStep(stepIndex) {
  let isStepValid = true;
  const currentStepElement = steps[stepIndex];
  const fields = currentStepElement.querySelectorAll("input, textarea, select");
  
  fields.forEach(field => {
    // We run validateField on every field, which updates its UI.
    // If any one of them returns false, the whole step is marked invalid.
    if (!validateField(field)) {
      isStepValid = false;
    }
  });
  
  return isStepValid;
}

function nextStep() {
  if (validateStep(currentStep)) {
    if (currentStep < steps.length - 1) {
      showStep(currentStep + 1);
    }
  }
}

function prevStep() {
  if (currentStep > 0) {
    showStep(currentStep - 1);
  }
}

// --- ðŸ’¡ [NEW] ADD REAL-TIME VALIDATION LISTENERS ---
document.querySelectorAll("input, textarea, select").forEach(field => {
  // Validate as user types
  field.addEventListener("input", () => validateField(field));
  // Validate when user clicks away
  field.addEventListener("change", () => validateField(field));
});

// Initialize first step on load
showStep(0);


// --- ADVANCED FILE UPLOADER (No changes needed) ---
const dropArea = document.getElementById("dropArea");
const fileInput = document.getElementById("fileInput");
const filePreview = document.getElementById("filePreview");
const previewToolbar = document.getElementById("previewToolbar");
const clearFilesBtn = document.getElementById("clearFilesBtn");
dropArea.onclick = () => fileInput.click();
['dragenter', 'dragover'].forEach(eventName => {
  dropArea.addEventListener(eventName, (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropArea.classList.add("dragover");
  }, false);
});
['dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropArea.classList.remove("dragover");
  }, false);
});
dropArea.addEventListener("drop", (e) => {
  const dt = e.dataTransfer;
  const files = dt.files;
  fileInput.files = files;
  previewFiles(files);
});
fileInput.addEventListener("change", () => {
  previewFiles(fileInput.files);
});
clearFilesBtn.addEventListener("click", () => {
    fileInput.value = null;
    filePreview.innerHTML = "";
    previewToolbar.style.display = "none";
});
function getFileIcon(fileType) {
  if (fileType.includes("zip") || fileType.includes("archive")) return "ðŸ“¦";
  if (fileType.includes("pdf")) return "ðŸ“•";
  if (fileType.includes("document") || fileType.includes("word")) return "ðŸ“";
  if (fileType.includes("spreadsheet") || fileType.includes("excel")) return "ðŸ“Š";
  if (fileType.includes("presentation") || fileType.includes("powerpoint")) return "ðŸ’»";
  if (fileType.includes("photoshop")) return "ðŸ–Œ";
  if (fileType.includes("illustrator")) return "âœ’";
  return "ðŸ“„"; // Generic Page
}
function previewFiles(files) {
  filePreview.innerHTML = "";
  if (!files || files.length === 0) {
    previewToolbar.style.display = "none";
    return;
  }
  previewToolbar.style.display = "flex";
  [...files].forEach(file => {
    const reader = new FileReader();
    const fileItem = document.createElement("div");
    fileItem.className = "file-item";
    const fileName = document.createElement("div");
    fileName.className = "file-name";
    fileName.textContent = file.name;
    fileName.title = file.name;
    if (file.type.startsWith("image/")) {
      reader.onload = (e) => {
        const img = document.createElement("img");
        img.src = e.target.result;
        fileItem.prepend(img);
      };
      reader.readAsDataURL(file);
    } else if (file.type.startsWith("video/")) {
      const video = document.createElement("video");
      video.src = URL.createObjectURL(file);
      video.controls = false;
      video.muted = true;
      fileItem.prepend(video);
    } else if (file.type.startsWith("audio/")) {
      const audio = document.createElement("audio");
audio.src = URL.createObjectURL(file);
audio.controls = true;
fileItem.prepend(audio);
    } else {
      const fileIcon = document.createElement("div");
      fileIcon.className = "file-icon";
      fileIcon.textContent = getFileIcon(file.type);
      fileItem.prepend(fileIcon);
    }
    fileItem.appendChild(fileName);
    filePreview.appendChild(fileItem);
  });
}

// --- METADATA & FORM SUBMISSION ---
function populateMetadata() {
  document.getElementById("sessionID").value = "SID-" + Date.now() + "-" + Math.random().toString(36).slice(2);
  document.getElementById("timestampField").value = new Date().toISOString();
  document.getElementById("userAgentField").value = navigator.userAgent;
}

form.addEventListener("submit", async function(e) {
  e.preventDefault();
  
  // Validate the final step before submitting
  if (!validateStep(currentStep)) {
    return; // Don't submit if final step is invalid
  }

  // --- ðŸš¨ðŸš¨ðŸš¨ THIS IS THE CRITICAL ERROR ðŸš¨ðŸš¨ðŸš¨ ---
  // ---     YOU MUST REPLACE "WEBHOOK_URL_HERE"     ---
  const N8N_WEBHOOK_URL = "WEBHOOK_URL_HERE"; 
  // ----------------------------------------------------
  
  if (N8N_WEBHOOK_URL === "WEBHOOK_URL_HERE") {
    responseMessage.className = "error";
    responseMessage.textContent = "DEVELOPER: Please set the N8N_WEBHOOK_URL in the <script> tag.";
    return;
  }

  populateMetadata();
  submitButton.classList.add("loading");
  submitButton.disabled = true;
  responseMessage.className = "";
  responseMessage.style.display = "none";
  responseMessage.textContent = "";

  const formData = new FormData(form);

  try {
    const response = await fetch(N8N_WEBHOOK_URL, {
      method: "POST",
      body: formData,
    });
    if (response.ok) {
      responseMessage.className = "success";
      responseMessage.textContent = "âœ… Intelligence package submitted successfully! We will be in touch.";
      form.reset();
      filePreview.innerHTML = "";
      previewToolbar.style.display = "none";
      showStep(0);
    } else {
      const errorText = await response.text();
      responseMessage.className = "error";
      responseMessage.textContent = Error: Submission failed (Status: ${response.status}). Please try again.;
      console.error("Submission error:", response.status, errorText);
    }
  } catch (err) {
    responseMessage.className = "error";
    responseMessage.textContent = "Error: Connection failed. Please check your network and try again.";
    console.error("Network or fetch error:", err);
  } finally {
    submitButton.classList.remove("loading");
    submitButton.disabled = false;
  }
});
</script>
</body>
</html>
