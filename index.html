<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Universal Intelligence Intake Portal [v5.0 Stable]</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg-darkest: #050505;
  --bg-dark: #0F1115;
  --bg-mid: #181B21;
  --border-color: #2A2E35;
  --text-light: #F0F2F5;
  --text-mid: #889096;
  --primary-blue: #00AFFF;
  --primary-hover: #33CFFF;
  --primary-glow: rgba(0, 175, 255, 0.15);
  --success: #00E676;
  --error: #FF3D57;
  --input-bg: #13161B;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html { font-size: 16px; scroll-behavior: smooth; }

body {
  background: var(--bg-darkest);
  font-family: "Montserrat", sans-serif;
  color: var(--text-light);
  line-height: 1.6;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* --- Layout --- */
.container {
  width: 100%;
  max-width: 850px;
  margin: 40px auto;
  padding: clamp(20px, 5vw, 40px);
  background: var(--bg-dark);
  border-radius: 20px;
  border: 1px solid var(--border-color);
  box-shadow: 0 20px 80px rgba(0, 0, 0, 0.6);
  position: relative;
  overflow: hidden;
}

/* Top Glow Effect */
.container::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--primary-blue), transparent);
  opacity: 0.7;
}

h1 {
  color: var(--text-light);
  margin-bottom: 10px;
  text-align: center;
  font-size: clamp(1.8rem, 4vw, 2.5rem);
  font-weight: 700;
  letter-spacing: -0.5px;
}

h1 span { color: var(--primary-blue); }

h2 {
  color: var(--text-light);
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 1px solid var(--border-color);
  font-size: 1.5rem;
  font-weight: 600;
}

.subtitle {
  color: var(--text-mid);
  margin-bottom: 40px;
  text-align: center;
  font-size: 1rem;
}

/* --- Stepper --- */
.step-indicator-container {
  display: flex;
  justify-content: space-between;
  width: 100%;
  max-width: 600px;
  margin: 0 auto 50px;
  position: relative;
}

/* The connecting line */
.step-indicator-container::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 10px;
  right: 10px;
  height: 2px;
  background: var(--border-color);
  transform: translateY(-50%);
  z-index: 1;
}

/* The progress line (fills up as you go) */
.progress-line {
  position: absolute;
  top: 50%;
  left: 10px;
  height: 2px;
  background: var(--primary-blue);
  transform: translateY(-50%);
  z-index: 1;
  width: 0%; /* JS updates this */
  transition: width 0.4s ease;
}

.step-indicator {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  background: var(--bg-dark);
  border: 2px solid var(--border-color);
  z-index: 2;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-mid);
  font-weight: 600;
  font-size: 0.9rem;
  cursor: default;
}

.step-indicator.active {
  border-color: var(--primary-blue);
  color: var(--bg-darkest);
  background: var(--primary-blue);
  transform: scale(1.1);
  box-shadow: 0 0 25px var(--primary-glow);
}

.step-indicator.completed {
  border-color: var(--primary-blue);
  color: var(--primary-blue);
  background: var(--bg-dark);
  cursor: pointer; /* Allow clicking back */
}

.step-indicator.completed:hover {
  background: rgba(0, 175, 255, 0.1);
}

/* --- Forms --- */
.step { display: none; animation: fadeSlideIn 0.4s ease forwards; }
.step.active { display: block; }

@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.form-group { margin-bottom: 24px; position: relative; }

label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  font-size: 0.95rem;
  color: var(--text-light);
}

label.optional::after {
  content: "(Optional)";
  font-weight: 400;
  color: var(--text-mid);
  margin-left: 8px;
  font-size: 0.8rem;
  opacity: 0.7;
}

input[type="text"], input[type="url"], input[type="email"], textarea, select {
  width: 100%;
  padding: 14px 16px;
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  color: var(--text-light);
  border-radius: 10px;
  font-size: 1rem;
  font-family: "Montserrat", sans-serif;
  transition: all 0.2s ease;
}

/* Hover & Focus states */
input:hover, textarea:hover, select:hover { border-color: #444; }

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--primary-blue);
  background: var(--bg-mid);
  box-shadow: 0 0 0 3px rgba(0, 175, 255, 0.1);
}

/* Validation States */
input.valid, textarea.valid, select.valid { border-color: rgba(0, 230, 118, 0.3); }
input.invalid, textarea.invalid, select.invalid { border-color: var(--error); }

textarea { resize: vertical; min-height: 120px; line-height: 1.5; }

/* Custom Select Arrow */
.select-wrapper { position: relative; }
select { appearance: none; cursor: pointer; }
.select-wrapper::after {
  content: 'â–¼';
  position: absolute;
  top: 50%;
  right: 16px;
  transform: translateY(-50%);
  color: var(--primary-blue);
  font-size: 0.7rem;
  pointer-events: none;
}

.error-message {
  color: var(--error);
  font-size: 0.85rem;
  margin-top: 6px;
  display: none;
  font-weight: 500;
}

/* --- Buttons --- */
.buttons { margin-top: 40px; display: flex; gap: 15px; }

button {
  flex: 1;
  padding: 16px;
  background: var(--primary-blue);
  border: none;
  color: var(--bg-darkest);
  font-weight: 700;
  border-radius: 10px;
  font-size: 1rem;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
}

button:hover {
  background: var(--primary-hover);
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(0, 175, 255, 0.2);
}

button:disabled {
  background: #2A2A2A;
  color: #555;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.back-btn {
  background: transparent;
  border: 1px solid var(--border-color);
  color: var(--text-mid);
}

.back-btn:hover {
  background: rgba(255,255,255,0.05);
  border-color: var(--text-light);
  color: var(--text-light);
  transform: translateY(-2px);
  box-shadow: none;
}

/* Spinner */
.loader-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(0,0,0,0.1);
  border-top-color: #000;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  display: none;
  margin-left: 10px;
}
.back-btn .loader-spinner { border-top-color: #fff; }
button.loading .loader-spinner { display: block; }
@keyframes spin { to { transform: rotate(360deg); } }

/* --- File Upload Area --- */
.drop-area {
  padding: 40px;
  border: 2px dashed var(--border-color);
  border-radius: 12px;
  text-align: center;
  color: var(--text-mid);
  cursor: pointer;
  transition: all 0.3s ease;
  background: rgba(255,255,255,0.01);
}

.drop-area:hover, .drop-area.dragover {
  border-color: var(--primary-blue);
  background: rgba(0, 175, 255, 0.05);
  color: var(--text-light);
}

.drop-area svg { width: 48px; height: 48px; margin-bottom: 15px; color: var(--primary-blue); }

.preview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 12px;
  margin-top: 20px;
}

.file-card {
  background: var(--bg-mid);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  overflow: hidden;
  font-size: 0.8rem;
}

.file-card-media {
  height: 80px;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-mid);
  font-size: 2rem;
}
.file-card-media img { width: 100%; height: 100%; object-fit: cover; }
.file-card-name {
  padding: 8px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text-light);
}
#clearFilesBtn {
  margin-top: 10px;
  background: transparent;
  color: var(--error);
  border: 1px solid var(--error);
  padding: 8px;
  font-size: 0.8rem;
  display: none;
}

/* --- Response Messages --- */
#responseMessage {
  text-align: center;
  font-weight: 600;
  margin-top: 20px;
  padding: 20px;
  border-radius: 12px;
  display: none;
}
#responseMessage.success { background: rgba(0, 230, 118, 0.1); color: var(--success); border: 1px solid var(--success); }
#responseMessage.error { background: rgba(255, 61, 87, 0.1); color: var(--error); border: 1px solid var(--error); }

/* --- Mobile Tweaks --- */
@media (max-width: 600px) {
  .container { margin: 0; border: none; border-radius: 0; min-height: 100vh; }
  h1 { font-size: 1.8rem; }
  .buttons { gap: 10px; }
  .step-indicator { width: 30px; height: 30px; font-size: 0.8rem; }
}
</style>
</head>
<body>

<div class="container">
  <h1>Universal <span>Intake</span></h1>
  <p class="subtitle">Advanced data ingestion portal. Please complete all required fields.</p>

  <div class="step-indicator-container">
    <div class="progress-line" id="progressLine"></div>
    <!-- data-step is 0-indexed in logic, 1-based for display -->
    <div class="step-indicator active" onclick="goToStep(0)">1</div>
    <div class="step-indicator" onclick="goToStep(1)">2</div>
    <div class="step-indicator" onclick="goToStep(2)">3</div>
    <div class="step-indicator" onclick="goToStep(3)">4</div>
    <div class="step-indicator" onclick="goToStep(4)">5</div>
  </div>

  <form id="intakeForm" novalidate>

    <!-- STEP 1 -->
    <div class="step active" id="step0">
      <h2>Basic Intelligence</h2>
      <div class="form-group">
        <label for="business_name">Business Entity Name *</label>
        <input type="text" id="business_name" name="business_name" required placeholder="e.g., Acme Corp" />
        <span class="error-message">Business name is required.</span>
      </div>
      <div class="form-group">
        <label for="website_main" class="optional">Primary Domain</label>
        <input type="text" id="website_main" name="website_main" placeholder="example.com" />
        <span class="error-message">Invalid URL format.</span>
      </div>
      <div class="form-group">
        <label for="website_extra" class="optional">Additional Domains (One per line)</label>
        <textarea id="website_extra" name="website_extra" placeholder="store.example.com&#10;blog.example.com"></textarea>
      </div>
      <div class="buttons">
        <button type="button" onclick="nextStep()">Next &rarr;</button>
      </div>
    </div>

    <!-- STEP 2 -->
    <div class="step" id="step1">
      <h2>Strategy Definition</h2>
      <div class="form-group">
        <label for="goal">Core Objective *</label>
        <div class="select-wrapper">
          <select id="goal" name="goal" required>
            <option value="" disabled selected>Select primary objective...</option>
            <option value="lead_gen">Lead Generation / Sales</option>
            <option value="branding">Brand Positioning</option>
            <option value="audit">Comprehensive Audit</option>
            <option value="expansion">Market Expansion</option>
            <option value="other">Other (Specify below)</option>
          </select>
        </div>
        <span class="error-message">Selection required.</span>
      </div>
      <div class="form-group">
        <label for="description" class="optional">Business Description</label>
        <textarea id="description" name="description" placeholder="What specific problems do you solve?"></textarea>
      </div>
      <div class="buttons">
        <button type="button" class="back-btn" onclick="prevStep()">Back</button>
        <button type="button" onclick="nextStep()">Next &rarr;</button>
      </div>
    </div>

    <!-- STEP 3 -->
    <div class="step" id="step2">
      <h2>Competitor Intel</h2>
      <div class="form-group">
        <label for="competitors" class="optional">Known Competitors (URLs or Names)</label>
        <textarea id="competitors" name="competitors" placeholder="competitor1.com&#10;Competitor 2 Inc."></textarea>
      </div>
      <div class="form-group">
        <label for="scrape_depth">Data Scraping Level *</label>
        <div class="select-wrapper">
          <select id="scrape_depth" name="scrape_depth" required>
            <option value="" disabled selected>Select depth...</option>
            <option value="none">Do not scrape my site</option>
            <option value="basic">Basic (Homepage only)</option>
            <option value="deep">Deep (Up to 50 pages)</option>
          </select>
        </div>
        <span class="error-message">Required.</span>
      </div>
      <div class="buttons">
        <button type="button" class="back-btn" onclick="prevStep()">Back</button>
        <button type="button" onclick="nextStep()">Next &rarr;</button>
      </div>
    </div>

    <!-- STEP 4 -->
    <div class="step" id="step3">
      <h2>Asset Upload</h2>
      <div class="form-group">
        <div class="drop-area" id="dropArea">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
          <p><strong>Click or Drag Files Here</strong><br><small>Images, PDFs, Documents, Archives</small></p>
        </div>
        <input type="file" id="fileInput" name="files" multiple style="display:none;" />
        
        <div class="preview-grid" id="filePreview"></div>
        <button type="button" id="clearFilesBtn">Clear All Files</button>
      </div>
      <div class="buttons">
        <button type="button" class="back-btn" onclick="prevStep()">Back</button>
        <button type="button" onclick="nextStep()">Next &rarr;</button>
      </div>
    </div>

    <!-- STEP 5 -->
    <div class="step" id="step4">
      <h2>Submission Protocol</h2>
      <div class="form-group">
        <label for="email">Contact Email *</label>
        <input type="email" id="email" name="email" required placeholder="name@company.com" />
        <span class="error-message">Valid email required.</span>
      </div>
      <div class="form-group">
        <label for="notes" class="optional">Final Notes / Context</label>
        <textarea id="notes" name="notes" placeholder="Any fallback instructions if data is missing?"></textarea>
      </div>
      
      <input type="hidden" name="timestamp" id="tsField">
      
      <div class="buttons">
        <button type="button" class="back-btn" onclick="prevStep()">Back</button>
        <button type="submit" id="submitBtn">
          <span class="btn-text">Submit Intelligence</span>
          <div class="loader-spinner"></div>
        </button>
      </div>
    </div>
  </form>

  <div id="responseMessage"></div>

</div>

<script>
/* --- CONFIGURATION --- */
// Set this to true to test the success animation without a real backend
const SIMULATION_MODE = true; 
// Replace with your N8N or Zapier Webhook URL
const WEBHOOK_URL = "https://YOUR_WEBHOOK_URL_HERE"; 

/* --- STATE MANAGEMENT --- */
let currentStep = 0;
const totalSteps = 5;
const steps = document.querySelectorAll(".step");
const indicators = document.querySelectorAll(".step-indicator");
const progressLine = document.getElementById("progressLine");
const form = document.getElementById("intakeForm");

/* --- NAVIGATION LOGIC --- */
function updateUI() {
  // Update Step Visibility
  steps.forEach((step, idx) => {
    step.classList.toggle("active", idx === currentStep);
  });

  // Update Indicators
  indicators.forEach((ind, idx) => {
    ind.classList.remove("active", "completed");
    if (idx === currentStep) {
      ind.classList.add("active");
    } else if (idx < currentStep) {
      ind.classList.add("completed");
    }
  });

  // Update Progress Bar Line
  const percent = (currentStep / (totalSteps - 1)) * 100;
  progressLine.style.width = percent + "%";
}

function validateStep(stepIndex) {
  const currentStepEl = steps[stepIndex];
  const inputs = currentStepEl.querySelectorAll("input, select, textarea");
  let isValid = true;
  let firstError = null;

  inputs.forEach(input => {
    if (!validateField(input)) {
      isValid = false;
      if (!firstError) firstError = input;
    }
  });

  if (firstError) {
    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    firstError.focus();
  }

  return isValid;
}

function validateField(input) {
  // Skip validation for optional fields IF they are empty
  // But if they have content (like a partial URL), we still validate format
  const isRequired = input.hasAttribute("required");
  const val = input.value.trim();
  const parent = input.closest(".form-group");
  const errorMsg = parent ? parent.querySelector(".error-message") : null;
  
  let fieldValid = true;

  // 1. Required Check
  if (isRequired && val === "") {
    fieldValid = false;
  } 
  
  // 2. Email Check
  if (fieldValid && val !== "" && input.type === "email") {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(val)) fieldValid = false;
  }

  // 3. URL Check (Smart)
  if (fieldValid && val !== "" && (input.id.includes("website") || input.id.includes("competitors"))) {
    // If textarea, split by lines
    const lines = input.tagName === "TEXTAREA" ? val.split('\n') : [val];
    
    for (let line of lines) {
      line = line.trim();
      if (line === "") continue;
      
      // Auto-fix missing protocol for validation logic
      let urlToTest = line;
      if (!/^https?:\/\//i.test(line)) {
        urlToTest = "https://" + line;
      }
      
      try {
        new URL(urlToTest);
      } catch (e) {
        fieldValid = false;
        break;
      }
    }
  }

  // Visual Feedback
  if (fieldValid) {
    input.classList.remove("invalid");
    input.classList.add("valid");
    if (errorMsg) errorMsg.style.display = "none";
  } else {
    input.classList.add("invalid");
    input.classList.remove("valid");
    if (errorMsg) errorMsg.style.display = "block";
  }

  return fieldValid;
}

function nextStep() {
  if (validateStep(currentStep)) {
    currentStep++;
    updateUI();
    window.scrollTo(0, 0);
  }
}

function prevStep() {
  if (currentStep > 0) {
    currentStep--;
    updateUI();
  }
}

function goToStep(stepIndex) {
  // Only allow clicking back to previously completed steps
  if (stepIndex < currentStep) {
    currentStep = stepIndex;
    updateUI();
  }
}

/* --- REAL-TIME VALIDATION LISTENER --- */
document.querySelectorAll("input, textarea, select").forEach(el => {
  el.addEventListener("blur", () => validateField(el));
  el.addEventListener("input", () => {
    // Remove error immediately when typing starts
    el.classList.remove("invalid");
    const parent = el.closest(".form-group");
    if(parent && parent.querySelector(".error-message")) {
      parent.querySelector(".error-message").style.display = "none";
    }
  });
});

/* --- FILE UPLOAD LOGIC --- */
const dropArea = document.getElementById("dropArea");
const fileInput = document.getElementById("fileInput");
const filePreview = document.getElementById("filePreview");
const clearBtn = document.getElementById("clearFilesBtn");

dropArea.addEventListener("click", () => fileInput.click());

["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
  dropArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

["dragenter", "dragover"].forEach(eventName => {
  dropArea.addEventListener(eventName, () => dropArea.classList.add("dragover"), false);
});

["dragleave", "drop"].forEach(eventName => {
  dropArea.addEventListener(eventName, () => dropArea.classList.remove("dragover"), false);
});

dropArea.addEventListener("drop", handleDrop, false);
fileInput.addEventListener("change", function() { handleFiles(this.files) });

function handleDrop(e) {
  const dt = e.dataTransfer;
  const files = dt.files;
  fileInput.files = files; // Update input (Note: simple assignment for demo)
  handleFiles(files);
}

function handleFiles(files) {
  filePreview.innerHTML = "";
  if (files.length > 0) {
    clearBtn.style.display = "inline-block";
    [...files].forEach(previewFile);
  } else {
    clearBtn.style.display = "none";
  }
}

function previewFile(file) {
  const reader = new FileReader();
  const card = document.createElement("div");
  card.className = "file-card";
  
  const mediaDiv = document.createElement("div");
  mediaDiv.className = "file-card-media";
  
  const nameDiv = document.createElement("div");
  nameDiv.className = "file-card-name";
  nameDiv.textContent = file.name;

  reader.readAsDataURL(file);
  reader.onloadend = function() {
    if (file.type.startsWith("image/")) {
      const img = document.createElement("img");
      img.src = reader.result;
      mediaDiv.appendChild(img);
    } else {
      mediaDiv.textContent = getIcon(file.type);
    }
    card.appendChild(mediaDiv);
    card.appendChild(nameDiv);
    filePreview.appendChild(card);
  }
}

function getIcon(type) {
  if (type.includes("pdf")) return "ðŸ“„";
  if (type.includes("spreadsheet") || type.includes("excel") || type.includes("csv")) return "ðŸ“Š";
  if (type.includes("word") || type.includes("document")) return "ðŸ“";
  if (type.includes("zip")) return "ðŸ“¦";
  return "ðŸ“";
}

clearBtn.addEventListener("click", (e) => {
  e.stopPropagation(); // Prevent triggering dropArea click
  fileInput.value = "";
  filePreview.innerHTML = "";
  clearBtn.style.display = "none";
});

/* --- FORM SUBMISSION --- */
// Prevent "Enter" key from submitting form prematurely
window.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && e.target.nodeName !== "TEXTAREA" && e.target.nodeName !== "BUTTON") {
    e.preventDefault();
    // If we are on last step, verify, else trigger next
    if(currentStep < totalSteps - 1) {
      nextStep();
    }
  }
});

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  
  // Final Validation
  if (!validateStep(currentStep)) return;

  const btn = document.getElementById("submitBtn");
  const msg = document.getElementById("responseMessage");
  const ts = document.getElementById("tsField");
  
  ts.value = new Date().toISOString();
  
  btn.disabled = true;
  btn.classList.add("loading");
  msg.style.display = "none";

  const formData = new FormData(form);

  // --- SIMULATION MODE OR REAL FETCH ---
  if (SIMULATION_MODE) {
    // Fake network delay
    setTimeout(() => {
      btn.classList.remove("loading");
      btn.disabled = false;
      msg.className = "success";
      msg.innerHTML = "âœ… <strong>Simulation Success:</strong> Data is valid and ready.<br>Connect a real Webhook URL in the code to go live.";
      msg.style.display = "block";
      msg.scrollIntoView({ behavior: 'smooth' });
      console.log("Form Data Simulated:", Object.fromEntries(formData));
    }, 1500);
  } else {
    // Real Submission
    try {
      const response = await fetch(WEBHOOK_URL, {
        method: "POST",
        body: formData
      });

      btn.classList.remove("loading");
      btn.disabled = false;

      if (response.ok) {
        msg.className = "success";
        msg.textContent = "Success! Intelligence package received.";
        msg.style.display = "block";
        form.reset();
        filePreview.innerHTML = "";
        currentStep = 0;
        updateUI();
      } else {
        throw new Error("Server returned " + response.status);
      }
    } catch (err) {
      btn.classList.remove("loading");
      btn.disabled = false;
      msg.className = "error";
      msg.textContent = "Submission Failed: Check Webhook URL or Network.";
      msg.style.display = "block";
      console.error(err);
    }
  }
});

// Initialize
updateUI();
</script>

</body>
</html>
