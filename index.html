<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epoch Scheduler</title>
    
    <!-- Using Tailwind for a premium, stable, and responsive UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            /* Transition for background color */
            @apply transition-colors duration-300;
        }

        /* Light mode (default) */
        :root {
            --bg: #f4f4f5; /* zinc-100 */
            --card-bg: #ffffff;
            --text-primary: #18181b; /* zinc-900 */
            --text-secondary: #52525b; /* zinc-600 */
            --border: #e4e4e7; /* zinc-200 */
            --primary: #2563eb; /* blue-600 */
            --primary-text: #ffffff;
        }

        /* Dark mode */
        html.dark {
            --bg: #09090b; /* zinc-950 */
            --card-bg: #18181b; /* zinc-900 */
            --text-primary: #f4f4f5; /* zinc-100 */
            --text-secondary: #a1a1aa; /* zinc-400 */
            --border: #27272a; /* zinc-800 */
            --primary: #3b82f6; /* blue-500 */
            --primary-text: #ffffff;
        }

        /* Applying theme colors */
        body {
            background-color: var(--bg);
            color: var(--text-primary);
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
        }
        .text-main { color: var(--text-primary); }
        .text-sub { color: var(--text-secondary); }
        .border-main { border-color: var(--border); }
        .button-primary {
            background-color: var(--primary);
            color: var(--primary-text);
        }
        .button-secondary {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        /* Styling for inputs to match theme */
        input[type="time"], input[type="text"] {
            background-color: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        /* Ensure placeholders are visible in dark mode */
        ::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }
        
        /* Modal styles for the premium feel */
        .modal-backdrop {
            @apply fixed inset-0 z-40 bg-black/50 backdrop-blur-sm;
            animation: fadeIn 0.2s ease;
        }
        .modal-content {
            @apply fixed z-50 w-full max-w-md p-6 rounded-t-2xl sm:rounded-2xl;
            /* Mobile-first: bottom sheet */
            bottom: 0; left: 0; right: 0;
            /* Desktop: centered */
            sm:bottom-auto sm:left-1/2 sm:top-1/2 sm:transform sm:-translate-x-1/2 sm:-translate-y-1/2;
            background-color: var(--card-bg);
            animation: slideUp 0.3s ease-out;
        }
        @media (min-width: 640px) {
            .modal-content {
                animation: scaleIn 0.3s ease-out;
            }
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes scaleIn { 
            from { opacity: 0; transform: translate(-50%, -45%) scale(0.95); } 
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); } 
        }
        @keyframes slideInItem {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .schedule-item-animation {
            animation: slideInItem 0.3s ease-out forwards;
        }
        
        /* Custom focus rings for better accessibility */
        input:focus {
             outline: 2px solid var(--primary);
             outline-offset: 2px;
             border-color: var(--primary);
        }
        .button-primary:focus-visible, .button-secondary:focus-visible, button:focus-visible {
             outline: 2px solid var(--primary);
             outline-offset: 2px;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="sticky top-0 z-10 p-4" style="background-color: var(--bg); opacity: 0.95;">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-main">Epoch</h1>
            <button id="theme-toggle" class="p-2 rounded-full text-sub hover:text-main">
                <!-- Icon Injected by JS -->
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-3xl mx-auto p-4">
        <!-- Today's Date -->
        <div class="mb-6">
            <h2 id="today-date" class="text-xl font-semibold text-main"></h2>
            <p class="text-sub">Your schedule for today.</p>
        </div>

        <!-- Schedule List -->
        <ul id="schedule-list" class="space-y-3">
            <!-- Empty state is a template, cloned by JS -->
        </ul>
        
        <!-- Empty State Template (hidden by default) -->
        <template id="empty-state-template">
            <li id="empty-state" class="text-center py-10 card rounded-lg">
                <p class="text-sub">Your day is empty.</p>
                <button id="start-planning-empty" class="mt-4 px-4 py-2 rounded-lg button-primary text-sm font-medium">
                    Start Planning
                </button>
            </li>
        </template>
            
    </main>
    
    <!-- Floating Action Button -->
    <button id="fab-add" class="fixed z-30 bottom-6 right-6 w-14 h-14 rounded-full button-primary shadow-lg flex items-center justify-center transition-transform hover:scale-105 active:scale-95">
        <!-- Plus Icon Injected by JS -->
    </button>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden">
        
        <!-- Onboarding Modal -->
        <div id="onboarding-modal" class="hidden">
            <div class="modal-backdrop"></div>
            <div class="modal-content">
                <h2 class="text-xl font-bold text-main mb-2">Welcome!</h2>
                <p class="text-sub mb-6">Let's design your day. What time do you wake up?</p>
                <form id="onboarding-form">
                    <label for="wake-up" class="text-sm font-medium text-sub">Wake Up Time</label>
                    <input type="time" id="wake-up" value="07:00" class="w-full p-3 mt-1 rounded-lg text-lg">
                    <button type="submit" class="w-full p-3 mt-6 rounded-lg button-primary font-semibold">
                        Start Planning
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Task Modal -->
        <div id="task-modal" class="hidden">
            <div class="modal-backdrop"></div>
            <div class="modal-content">
                <h2 id="task-modal-title" class="text-xl font-bold text-main mb-6">What's next?</h2>
                <form id="task-form" class="space-y-4">
                    <input type="hidden" id="task-id"> <!-- For editing -->
                    
                    <div>
                        <label for="task-name" class="text-sm font-medium text-sub">What are you doing?</label>
                        <input type="text" id="task-name" placeholder="e.g., Deep Work Session" class="w-full p-3 mt-1 rounded-lg" required>
                    </div>

                    <!-- "AI" Suggestions -->
                    <div id="suggestions-container" class="pt-1">
                        <label class="text-sm font-medium text-sub">Suggestions</label>
                        <div id="suggestions-chips" class="flex flex-wrap gap-2 mt-2">
                            <!-- Chips injected here -->
                        </div>
                    </div>

                    <!-- Time Inputs -->
                    <div class="flex gap-4 w-full">
                        <div class="w-1/2">
                            <label for="start-time" class="text-sm font-medium text-sub">From</label>
                            <input type="time" id="start-time" class="w-full p-3 mt-1 rounded-lg" required>
                        </div>
                        <div class="w-1/2">
                            <label for="end-time" class="text-sm font-medium text-sub">To</label>
                            <input type="time" id="end-time" class="w-full p-3 mt-1 rounded-lg" required>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-4 pt-4">
                        <button type="button" id="delete-task-btn" class="w-1/3 py-3 rounded-lg button-secondary font-semibold hidden">
                            Delete
                        </button>
                        <button type="submit" id="save-task-btn" class="flex-grow py-3 rounded-lg button-primary font-semibold">
                            Save Task
                        </button>
                    </div>
                    
                    <button type="button" id="finish-planning-btn" class="w-full py-3 rounded-lg font-semibold text-sub hover:text-main">
                        I'm done planning for now
                    </button>
                </form>
            </div>
        </div>
        
    </div> <!-- End Modal Container -->

    <script>
        // Use an IIFE to scope variables and prevent global pollution
        (function() {
            // --- STATE ---
            let schedule = [];
            let isContinuousPlanning = false;
            let activeReminders = {}; // Store setTimeout IDs

            // --- "AI" SUGGESTIONS ---
            const suggestions = {
                morning: ['Deep Work', 'Planning', 'Emails', 'Workout'],
                noon: ['Lunch', 'Walk', 'Admin', 'Read'],
                afternoon: ['Meetings', 'Project Work', 'Errands'],
                evening: ['Cook', 'Social', 'Rest', 'Read'],
                generic: ['Meditate', 'Journal', 'Hydrate', 'Break']
            };

            // --- PURE SVG ICONS (NO DEPENDENCIES) ---
            const icons = {
                sun: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>`,
                moon: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>`,
                plus: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>`,
                trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>`,
            };

            // --- DOM ELEMENTS ---
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            const dom = {
                html: document.documentElement,
                themeToggle: $('#theme-toggle'),
                todayDate: $('#today-date'),
                scheduleList: $('#schedule-list'),
                emptyStateTemplate: $('#empty-state-template'),
                fabAdd: $('#fab-add'),
                modalContainer: $('#modal-container'),
                onboardingModal: $('#onboarding-modal'),
                onboardingForm: $('#onboarding-form'),
                taskModal: $('#task-modal'),
                taskForm: $('#task-form'),
                taskModalTitle: $('#task-modal-title'),
                taskId: $('#task-id'),
                taskName: $('#task-name'),
                startTime: $('#start-time'),
                endTime: $('#end-time'),
                deleteTaskBtn: $('#delete-task-btn'),
                finishPlanningBtn: $('#finish-planning-btn'),
                suggestionsContainer: $('#suggestions-container'),
                suggestionsChips: $('#suggestions-chips'),
            };

            // --- INITIALIZATION ---
            document.addEventListener('DOMContentLoaded', () => {
                // 1. Load state from localStorage
                loadTheme();
                loadSchedule();

                // 2. Set up UI
                dom.fabAdd.innerHTML = icons.plus;
                updateThemeIcon();
                updateTodayDate();
                renderSchedule();

                // 3. Set up event listeners
                setupEventListeners();

                // 4. Request notification permission
                requestNotificationPermission();
            });

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                dom.themeToggle.addEventListener('click', toggleTheme);
                
                // Modal triggers
                dom.fabAdd.addEventListener('click', () => {
                    isContinuousPlanning = false;
                    const lastTask = schedule[schedule.length - 1];
                    const nextStart = lastTask ? lastTask.end : '09:00';
                    openTaskModal({ start: nextStart });
                });
                
                // Note: The empty state button is added dynamically,
                // so its listener is added in renderSchedule()
                
                // Onboarding
                dom.onboardingForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const wakeUpTime = $('#wake-up').value;
                    hideModal(dom.onboardingModal);
                    
                    isContinuousPlanning = true; // Start the flow
                    openTaskModal({ start: wakeUpTime });
                });

                // Task Form
                dom.taskForm.addEventListener('submit', handleTaskSave);
                dom.deleteTaskBtn.addEventListener('click', handleDeleteTask);
                dom.finishPlanningBtn.addEventListener('click', () => {
                    isContinuousPlanning = false;
                    hideModal(dom.taskModal);
                });

                // Close modal on backdrop click
                $$('.modal-backdrop').forEach(backdrop => {
                    backdrop.addEventListener('click', () => {
                        isContinuousPlanning = false;
                        hideModal(dom.onboardingModal);
                        hideModal(dom.taskModal);
                    });
                });
            }

            // --- THEME ---
            function loadTheme() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                dom.html.className = savedTheme;
            }

            function toggleTheme() {
                dom.html.classList.toggle('dark');
                dom.html.classList.toggle('light');
                const newTheme = dom.html.classList.contains('dark') ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
                updateThemeIcon();
            }

            function updateThemeIcon() {
                if (dom.html.classList.contains('dark')) {
                    dom.themeToggle.innerHTML = icons.sun;
                } else {
                    dom.themeToggle.innerHTML = icons.moon;
                }
            }
            
            // --- UI & DATE ---
            function updateTodayDate() {
                const today = new Date();
                dom.todayDate.textContent = today.toLocaleDateString(undefined, {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric'
                });
            }

            // --- MODALS ---
            function showModal(modal) {
                dom.modalContainer.classList.remove('hidden');
                modal.classList.remove('hidden');
            }

            function hideModal(modal) {
                modal.classList.add('hidden');
                // Check if any *other* modals are open
                const anyModalOpen = $$('#modal-container > div:not(.hidden)').length > 0;
                if (!anyModalOpen) {
                    dom.modalContainer.classList.add('hidden');
                }
            }

            // --- TASK MANAGEMENT ---
            function loadSchedule() {
                schedule = JSON.parse(localStorage.getItem('schedule')) || [];
                schedule.sort((a, b) => a.start.localeCompare(b.start)); // Sort by time
            }

            function saveSchedule() {
                schedule.sort((a, b) => a.start.localeCompare(b.start));
                localStorage.setItem('schedule', JSON.stringify(schedule));
            }

            function renderSchedule() {
                dom.scheduleList.innerHTML = ''; // Clear list
                clearReminders(); // Clear old reminders
                
                if (schedule.length === 0) {
                    const emptyStateNode = dom.emptyStateTemplate.content.cloneNode(true);
                    dom.scheduleList.appendChild(emptyStateNode);
                    
                    // Attach listener to the new empty state button
                    $('#start-planning-empty').addEventListener('click', () => {
                        showModal(dom.onboardingModal);
                    });
                    return;
                }

                schedule.forEach((task, index) => {
                    const li = document.createElement('li');
                    li.className = 'card rounded-lg p-4 flex items-center justify-between schedule-item-animation cursor-pointer';
                    li.style.animationDelay = `${index * 50}ms`; // Stagger animation
                    li.dataset.id = task.id;

                    li.innerHTML = `
                        <div class="flex items-center pointer-events-none"> <!-- pointer-events-none to pass click to li -->
                            <div class="flex-shrink-0 w-16">
                                <p class="font-semibold text-sm text-main">${formatTime(task.start)}</p>
                                <p class="text-xs text-sub">to ${formatTime(task.end)}</p>
                            </div>
                            <div class="ml-4 border-l-2 pl-4" style="border-color: var(--primary);">
                                <p class="font-medium text-main">${task.name}</p>
                                <p class="text-sm text-sub">${getDuration(task.start, task.end)}</min>
                            </div>
                        </div>
                        <button class="delete-btn p-2 rounded-full text-sub hover:text-red-500 z-10">
                            ${icons.trash}
                        </button>
                    `;
                    
                    // Add delete functionality
                    li.querySelector('.delete-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); // Stop task click
                        schedule = schedule.filter(t => t.id !== task.id);
                        saveSchedule();
                        renderSchedule();
                    });

                    // Add edit functionality
                    li.addEventListener('click', () => {
                        isContinuousPlanning = false;
                        openTaskModal(task);
                    });
                    
                    dom.scheduleList.appendChild(li);
                    
                    // Set a reminder for this task
                    setReminder(task);
                });
            }

            function handleTaskSave(e) {
                e.preventDefault();
                
                const task = {
                    id: dom.taskId.value || `task-${Date.now()}`,
                    name: dom.taskName.value,
                    start: dom.startTime.value,
                    end: dom.endTime.value
                };

                // Simple validation
                if (!task.name || !task.start || !task.end) {
                    alert("Please fill out all fields.");
                    return;
                }
                
                if (timeToMinutes(task.end) <= timeToMinutes(task.start)) {
                    alert("End time must be after start time.");
                    return;
                }

                if (checkConflict(task)) {
                    // This is a more premium-feeling "alert"
                    showTempAlert("Warning: This task overlaps with an existing task!");
                }

                // Find and replace if editing, or add new
                const existingIndex = schedule.findIndex(t => t.id === task.id);
                if (existingIndex > -1) {
                    schedule[existingIndex] = task;
                } else {
                    schedule.push(task);
                }

                saveSchedule();
                renderSchedule();

                if (isContinuousPlanning) {
                    // This is the "continuous" flow
                    openTaskModal({ start: task.end }); // Open next modal
                } else {
                    hideModal(dom.taskModal);
                }
            }

            function handleDeleteTask() {
                const id = dom.taskId.value;
                schedule = schedule.filter(t => t.id !== id);
                saveSchedule();
                renderSchedule();
                hideModal(dom.taskModal);
                isContinuousPlanning = false;
            }

            function openTaskModal(task) { // task = {id?, name?, start?, end?}
                dom.taskId.value = task.id || '';
                dom.taskName.value = task.name || '';
                dom.startTime.value = task.start || '';
                dom.endTime.value = task.end || (task.start ? addMinutes(task.start, 60) : '');
                
                if (task.id) {
                    // Editing existing task
                    dom.taskModalTitle.textContent = 'Edit Task';
                    dom.deleteTaskBtn.classList.remove('hidden');
                } else {
                    // Adding new task
                    dom.taskModalTitle.textContent = isContinuousPlanning ? "What's next?" : "Add New Task";
                    dom.deleteTaskBtn.classList.add('hidden');
                }
                
                populateSuggestions(task);
                showModal(dom.taskModal);
                dom.taskName.focus(); // Auto-focus
            }

            // --- "AI" SUGGESTIONS ---
            function populateSuggestions(task) {
                dom.suggestionsChips.innerHTML = '';
                let suggestionSet = new Set(suggestions.generic);
                
                const startHour = parseInt((task.start || '09:00').split(':')[0]);
                
                if (startHour >= 5 && startHour < 12) {
                    suggestions.morning.forEach(s => suggestionSet.add(s));
                } else if (startHour >= 12 && startHour < 17) {
                    suggestions.noon.forEach(s => suggestionSet.add(s));
                } else if (startHour >= 17 && startHour < 21) {
                    suggestions.evening.forEach(s => suggestionSet.add(s));
                }

                suggestionSet.forEach(text => {
                    const chip = document.createElement('button');
                    chip.type = 'button';
                    chip.className = 'px-3 py-1 rounded-full text-sm';
                    chip.style.backgroundColor = 'var(--bg)';
                    chip.style.color = 'var(--text-secondary)';
                    chip.textContent = text;
                    chip.onclick = () => { dom.taskName.value = text; };
                    dom.suggestionsChips.appendChild(chip);
                });
            }

            // --- REMINDERS & NOTIFICATIONS ---
            function requestNotificationPermission() {
                if ('Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            }

            function clearReminders() {
                Object.values(activeReminders).forEach(clearTimeout);
                activeReminders = {};
            }

            function setReminder(task) {
                const now = new Date();
                const [hours, minutes] = task.start.split(':');
                const taskTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                
                const timeToTask = taskTime.getTime() - now.getTime();

                if (timeToTask > 0) { // Only for future tasks
                    const reminderID = setTimeout(() => {
                        showNotification(task);
                    }, timeToTask);
                    activeReminders[task.id] = reminderID;
                }
            }

            function showNotification(task) {
                const body = `Your task "${task.name}" is starting now.`;
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Task Reminder', { body: body });
                } else {
                    // Fallback for when notifications are not granted
                    // This is a custom toast-like alert. Much better than window.alert()
                    showTempAlert(`Reminder: ${body}`);
                }
            }
            
            // --- CUSTOM ALERT (BETTER THAN window.alert()) ---
            function showTempAlert(message) {
                let alertBox = $('#temp-alert');
                if (!alertBox) {
                    alertBox = document.createElement('div');
                    alertBox.id = 'temp-alert';
                    alertBox.className = 'fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg shadow-lg text-white font-medium';
                    alertBox.style.backgroundColor = '#ef4444'; // Red
                    document.body.appendChild(alertBox);
                }
                alertBox.textContent = message;
                alertBox.style.opacity = '1';
                alertBox.style.transition = 'opacity 0.3s';
                
                setTimeout(() => {
                    alertBox.style.opacity = '0';
                }, 3000);
            }

            // --- UTILITY FUNCTIONS ---
            function formatTime(timeString) { // "14:30"
                const [hours, minutes] = timeString.split(':').map(Number);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const h = hours % 12 === 0 ? 12 : hours % 12;
                return `${h}:${String(minutes).padStart(2, '0')} ${ampm}`;
            }

            function timeToMinutes(time) { // "14:30" -> 870
                const [hours, minutes] = time.split(':').map(Number);
                return (hours * 60) + minutes;
            }

            function addMinutes(timeString, mins) {
                let totalMins = timeToMinutes(timeString) + mins;
                if (totalMins >= 1440) totalMins = 1439; // Cap at 23:59
                const h = Math.floor(totalMins / 60);
                const m = totalMins % 60;
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            }

            function getDuration(start, end) {
                const diff = timeToMinutes(end) - timeToMinutes(start);
                if (diff <= 0) return '0m';
                const h = Math.floor(diff / 60);
                const m = diff % 60;
                return (h > 0 ? `${h}h ` : '') + (m > 0 ? `${m}m` : '');
            }
            
            function checkConflict(task) {
                const startMins = timeToMinutes(task.start);
                const endMins = timeToMinutes(task.end);

                return schedule.some(t => {
                    if (t.id === task.id) return false; // Don't check against self
                    const tStart = timeToMinutes(t.start);
                    const tEnd = timeToMinutes(t.end);
                    // Check for overlap
                    return (startMins < tEnd) && (endMins > tStart);
                });
            }

        })(); // End of IIFE
    </script>
</body>
</html>

